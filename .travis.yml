language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "cVw6SAdQv/D3RjOHky8xm1IiaLJKEFQ8k97eWHLN0B9aPGSJmONFTL/sdPXkUwr5iBFrWAht1vLDJjptUGY5vg3iOWeME3uvHzTRgPYgp8B7pdSlY2+yMVegR5XC6mSBfnqKcml/fdd3b5FRLoZAVWaRdak0DYLjPuu/erbBZYPKhvUTlz7s8QiccBUoMwFUsj/yhdVfeIcLGfFpC+D/HcZ9wlh/Zzg8XJ/lI0AsrSGG+OAnpvqmzxW9iBWvg9WcmxNkX3yQ00LKq0+jowzqfraPiJLCHsC4gXwotOTqesVkfP2Lh0anXJsIhP1/7ORN83ns4I6OkOSE3Ls/F8bo9TuisllFtI4VVLmsFkIua8MNGNrWG3D82un15oA1Gfj53YYEKuM1MW/NmfIjUpApEaL+zUvhX6xSR6eEzmEiqyGhvF0rCMirI//MdsgY3QiWE0Cns9c9r2FL2xHqbYW9ChicdRXHyVUOe7rZ5+EcPt2g8/ZRv2iwlSYhgHeEGhAkoXPFNNopsU8uYwhZsjWmjNNa9shhLXycWSF3lFwIrELBVTI0AiUDuWh2yYlEu8UirUqP0EqhAnlY2Bg2DmHbJl1KUzENyALjw0tuH0OMoCRjrcbfuN1E7QtXyuuFNBpcOPAw5uBV3Pr036W5HXLvOUYrtpJrZDh0e3UqjfobPOs="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "T6zCDS3vpWr/7LmEOOcwM6HAYz5JESc0CPa2Y7g0MvtfhBdd+9V+sgp9a1lPp135w6tWHmkuxvcjngraUKISwyI+6ZLAWFyODImD1h3uDgMOxXnEc1+wnkdDShHyVXoKVtd61UkoUqhimXw+hb/7CoPWg+27jWBsGfce1V131cezry+0Lxs57dBACdmqPjwgYy/Y49j1KW6Tfn7cf9aOoSI1jCxsBfp5HvBdyv6rBFrKSKsU5eA2fZrZPryoxB1adQaF9tAQZjzT7LMw8of5XRdMWW2NYVZM5bT/+xS6xxLM5MUDuGXHBcrU1wQeukz1Rr765JcbK5wKpeDmfkc13ziTgC7i2zE3Z1VUW5XVV62EnwS4HD1veOQlCrd0KMIEHd+GiV93JEzTws7ZF5WUmpumbNxxDLVtBKV4qUV9c+mcTAyOBD41LHsLbLzQXR6GNWgdj+PmqKBnz9FFeqiGIFma1DQIUn5gJVzMDbbjrNBsiY2UajjyxWhwKAGxDlkrs/oUf211VXAbLeM2XNoWpgm32+g6+1WIjDZpklLWYfEwnYIq+AGhwvPqB5KbaQpxlaAeCKMIA49TjH7+4UeBsYu+zYQgPbu0vILfY3N7NZbTPd78uAiT7wjhUPVfRsYbqb2DuhQO1sUFt8FhQojtJrexpJcq72qFfM3S2eBPmiY="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
